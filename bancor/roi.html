<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-34871125-3"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34871125-3');
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-orange.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/modules/data.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.10/js/select2.min.js"></script>
  <title>Bancor ROI By Token</title>
</head>
<body style="height:100%">
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-tabs mdl-layout--no-desktop-drawer-button">
    <header class="mdl-layout__header">
      <div class="mdl-layout__tab-bar mdl-js-ripple-effect">
        <a class="mdl-layout__tab" href="./liquidity.html">Liquidity</a>
        <a class="mdl-layout__tab" href="./providers.html">Liquidity Providers</a>
        <a class="mdl-layout__tab is-active" href="#">ROI</a>
        <a class="mdl-layout__tab" href="./total_volume.html">Trade Volume</a>
        <div class="mdl-layout-spacer"></div>
        <button class="mdl-button mdl-js-button mdl-button--accent" id="baseSelector" style="width: 100px; height: 48px">BNT</button>
      </div>
    </header>
    <div class="mdl-layout__drawer">
      <nav class="mdl-navigation">
        <a class="mdl-navigation__link" href="./liquidity.html">Liquidity</a>
        <a class="mdl-navigation__link" href="./providers.html">Liquidity Providers</a>
        <a class="mdl-navigation__link" href="#">ROI</a>
        <a class="mdl-navigation__link" href="./total_volume.html">Trade Volume</a>
      </nav>
    </div>
    <main class="mdl-layout__content" style="height:100%">
      <div class="mdl-layout__header-row">
        <div class="mdl-layout-spacer"></div>
        <span class="mdl-layout-title"><h3>Bancor ROI By Token</h3></span>
        <div class="mdl-layout-spacer"></div>
      </div>
      <div class="mdl-layout__header-row">
        <select id="tokenSelector" style="width: 110px">
          <option value="daibnt">DAIBNT</option>
        </select>
        <div class="mdl-layout-spacer"></div>
        <label id="report" style="font-size: 14pt"></label>
        <div class="mdl-layout-spacer"></div>
        <div id="info-tooltip" class="icon material-icons md-18" style="margin-right: 5px">info</div>
        <div class="mdl-tooltip" for="info-tooltip">
          Some useful <br> multiline info <br> will be there.
        </div>
        <select id="baselineSelector" style="width: 110px">
          <option value="token">Hodl Token</option>
          <option value="bnt">Hodl BNT</option>
          <option value="portfolio" selected="selected">Hodl 50/50</option>
        </select>
      </div>
      <noscript>
        You need to enable JavaScript to run this app.
      </noscript>
      <div id="container" style="height:79%;"></div>

      <script>
        const switcher = {
          'BNT': 'USDB',
          'USDB': 'BNT',
        };
        const base_selector = $('#baseSelector');
        const token_selector = $('#tokenSelector');
        var base_currency = base_selector.text().toLowerCase();
        var csv_url = undefined;
        var in_redraw = false;
        var cur_price, initial_price, dm_roi, cur_loss, performance;

        $('#baselineSelector').select2({
          minimumResultsForSearch: -1
        });

        function updateTokenSelector(destroy) {
          if (destroy) token_selector.select2('destroy');
          token_selector.select2({
            ajax: {
              url: './data/' + base_currency + '/tokens.json',
              dataType: 'json',
              cache: true
            }
          });
          $.ajax({
            type: 'GET',
            url: './data/' + base_currency + '/tokens.json'
          }).then(function (data) {
            // create the option and append to Select2
            var option = new Option(data.results[0].text, data.results[0].id, true, true);
            token_selector.append(option).trigger('change');

            // manually trigger the `select2:select` event
            token_selector.trigger({
              type: 'select2:select',
              params: {
                data: data.results[0]
              }
            });
          });
        }

        document.getElementById("baseSelector").addEventListener('click', function() {
          base_selector.html(switcher[base_selector.text()]);
          base_currency = base_selector.text().toLowerCase();
          updateTokenSelector(true);
        });

        $(document).ready(function() {
          updateTokenSelector(false);
        });

        function createChart() {
          Highcharts.stockChart('container', {
            rangeSelector: {
              selected: 2,
              buttons: [{
                type: 'week',
                count: 1,
                text: '1w'
              }, {
                type: 'month',
                count: 1,
                text: '1m'
              }, {
                type: 'month',
                count: 3,
                text: '3m'
              }, {
                type: 'all',
                text: 'All'
              }],
              inputEnabled: false
            },
            tooltip: {
             shared: true,
             split: false,
             followPointer: true,
             pointFormat: '{series.name}: <b>{point.y}</b><br>'
            },
            yAxis: [{
              labels: {
                format: '{value}%',
              },
              title: {
                text: ''
              },
              opposite: true
            }, {
              labels: {
                format: '{value} ' + base_currency
              },
              title: {
                text: ''
              },
              opposite: false
            }],
            legend: {
              enabled: true,
              align: 'center'
            },
            navigator: {
              enabled: false
            },
            credits: {
              enabled: false
            },
            data: {
              csvURL: csv_url
            },
            series: [{
              visible: false,
              showInLegend: false
            }, {
              visible: false,
              showInLegend: false
            }, {
              yAxis: 1,
              zIndex: 0,
              tooltip: {
                valueSuffix: ' ' + base_currency
              },
              type: 'column',
              color: '#bbb'
            }],
            xAxis: {
              events: {
                afterSetExtremes: function(e) {
                  if (in_redraw) return;
                  in_redraw = true;
                  var chartOb = this, price_ratio;
                  var cumulative_dm_roi = [];
                  var loss = [];
                  var net_position = []
                  dm_roi = 1;
                  initial_price = 0;

                  $.each(chartOb.series[0].xData,function(i,x){
                    if(x >= chartOb.min && x <= chartOb.max) {
                      if (initial_price == 0) {
                        initial_price = chartOb.series[1].yData[i];
                      }
                      dm_roi *= chartOb.series[0].yData[i];
                      cumulative_dm_roi.push([x, parseFloat(((dm_roi - 1) * 100).toFixed(2))]);
                      cur_price = chartOb.series[1].yData[i];
                      price_ratio = cur_price / initial_price;
                      cur_loss = 2.0 * Math.sqrt(price_ratio) / (1.0 + price_ratio);
                      loss.push([x, parseFloat(((cur_loss - 1) * 100).toFixed(2))]);
                      net_position.push([x, parseFloat(((cur_loss * dm_roi - 1) * 100).toFixed(2))]);
                    }
                  });

                  if (chartOb.series.length == 6) {
                    chartOb.series[3].setData(cumulative_dm_roi, false);
                    chartOb.series[4].setData(loss, false);
                    chartOb.series[5].setData(net_position, false);
                  } else {
                    chartOb.chart.addSeries({
                      name: 'Collected Fees',
                      data: cumulative_dm_roi,
                      yAxis: 0,
                      zIndex: 1,
                      tooltip: {
                        valueSuffix: '%'
                      },
                      color: Highcharts.getOptions().colors[5]
                    }, false);
                    chartOb.chart.addSeries({
                      name: 'Impermanent Loss',
                      data: loss,
                      yAxis: 0,
                      zIndex: 1,
                      tooltip: {
                        valueSuffix: '%'
                      },
                      color: Highcharts.getOptions().colors[0]
                    }, false);
                    chartOb.chart.addSeries({
                      name: 'Net Profit',
                      data: net_position,
                      yAxis: 0,
                      zIndex: 1,
                      tooltip: {
                        valueSuffix: '%'
                      },
                      color: Highcharts.getOptions().colors[6]
                    }, false);
                  }
                  chartOb.chart.redraw();

                  switch($("#baselineSelector option:selected").val()) {
                    case 'token':
                      performance = (1 + cur_price / initial_price) * cur_loss * dm_roi / 2;
                      break;
                    case 'bnt':
                      performance = (1 + initial_price / cur_price) * cur_loss * dm_roi / 2;
                      break;
                    case 'portfolio':
                      performance = cur_loss * dm_roi;
                      break;
                  }

                  $('#report').html(
                    'Bancor returns <b>' +
                    (performance > 1 ? '+' : '') +
                    ((performance - 1) * 100).toFixed(2) + '%</b> from baseline'
                  );

                  in_redraw = false;
                }
              }
            }
          });
        }

        $('#tokenSelector').on('select2:select', function (e) {
          csv_url = window.location.href;
          csv_url = csv_url.substring(0, csv_url.lastIndexOf('/'));
          csv_url = csv_url + '/data/' + base_currency + '/roi/' + e.params.data.id + '.csv';
          createChart();
        });

        $('#baselineSelector').on('select2:select', function (e) {
          switch(e.params.data.id) {
            case 'token':
              performance = (1 + cur_price / initial_price) * cur_loss * dm_roi / 2;
              break;
            case 'bnt':
              performance = (1 + initial_price / cur_price) * cur_loss * dm_roi / 2;
              break;
            case 'portfolio':
              performance = cur_loss * dm_roi;
              break;
          }

          $('#report').html(
            'Bancor returns <b>' +
            (performance > 1 ? '+' : '') +
            ((performance - 1) * 100).toFixed(2) + '%</b> from baseline'
          );
        });
      </script>
      <footer class="mdl-mini-footer" style="flex: 0 0 auto;padding:15px">
        <div class="mdl-mini-footer__left-section">
          <ul class="mdl-mini-footer__link-list">
            <li><a href="https://etherscan.io/address/0xa1ed93bf44ba35f1e8ebfb4d104a0e109337a5aa">Donations</a></li>
          </ul>
        </div>
        <div class="mdl-layout-spacer"></div>
        <div class="mdl-mini-footer__middle-section">
          <ul class="mdl-mini-footer__link-list">
            <li>ZumZoom Â© 2019</li>
          </ul>
        </div>
        <div class="mdl-layout-spacer"></div>
        <div class="mdl-mini-footer__right-section">
          <ul class="mdl-mini-footer__link-list">
            <li><a href="https://twitter.com/byZumZoom">Twitter</a></li>
            <li><a href="https://github.com/ZumZoom/analytics">GitHub</a></li>
          </ul>
        </div>
      </footer>
    </main>
  </div>
</body>
</html>
